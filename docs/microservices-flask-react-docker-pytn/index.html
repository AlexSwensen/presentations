<!DOCTYPE html>
<html>
  <head>
    <title>Developing Microservices with Flask, React, and Docker</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      td {
        padding-left: 5px;
        padding-right: 5px;
      }
      .remark-code { font-family: 'Ubuntu Mono'; }
      .remark-inline-code {
        font-family: 'Ubuntu Mono';
        padding: 2px 4px;
        font-size: 90%;
        color: #c7254e;
        background-color: #f9f2f4;
        border-radius: 0;
       }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Developing and Testing Microservices <br> with Flask, React, and Docker

<div style="text-align:center;">
  <img src="images/tech.png" style="max-width: 40%; border:0; box-shadow: none;" alt="microservices">
</div>

<br>

<div>
  <span style="vertical-align:60%;">Presented by <em>Michael Herman</em> at</span>
  <img src="images/pytn-logo.png" style="max-width: 7%; border:0; box-shadow: none;" alt="PyTennessee logo">
</div>


---

### Agenda (part 1)

‚è± ~ 1 hour

--

##### (1) Intro

1. About Me
1. Objectives
1. Architecture
1. Project Setup
1. Why Microservices?

--

##### (2) Containers and Services

1. Users DB (postgres)
1. Users API (flask)
1. Client (react)
1. Hot Reload
1. Nginx
1. End-to-End Tests
1. Docker Machine
1. EC2 Deployment

---


### Agenda (part 2)

‚è± ~ 1 hour

--

##### (3) Orchestration

1. What is Container Orchestration?
1. Why ECS?
1. Orchestration Feature Wish-list
1. Elastic Load Balancing (ELB)
1. Elastic Container Registry (ECR)
1. Elastic Container Service (ECS)
1. Setting up RDS
1. Workflow

--

##### (3) Goodbye

1. Next Steps
1. Questions

---

### About Michael

```
$ whoami
michael.herman
```

--

#### Day Job:

Software Engineer at [ClickFox](https://www.clickfox.com/).
&nbsp;
<img src="images/clickfox.png" style="max-width: 4%; border:0; box-shadow: none;" alt="clickfox logo">

--

#### Docker:

1. Avid Docker user since 2014.
1. Last year I architected and set up [On-Demand Environments With Docker and AWS ECS](http://mherman.org/blog/2017/09/18/on-demand-test-environments-with-docker-and-aws-ecs/).

--

#### Also:

1. Co-founder/author of [Real Python](https://realpython.com)
1. üòç - [tech writing/education](http://mherman.org), [open source](http://github.com/mjhea0), [financial models](http://www.starterfinancialmodel.com/), [radiohead](http://radiohead.com/)

<img src="images/me.png" style="max-width: 10%; border:0; box-shadow: none; padding-top:10px" alt="me">

---

### Objectives

By the end of this talk, you should be able to...

--

`Containerization`

1. Configure and run **microservices** locally with Docker
1. Utilize **volumes** to mount code into a container to enable **hot reload**
1. Run unit and integration **tests** inside a Docker container
1. Secure services via **JWT-based authentication**
1. Configure **React**, **Jest**, and **Enzyme** to work with Docker
1. Test the entire set of services with **functional, end-to-end** tests

--

`Orchestration`

1. Explain what **container orchestration** is and why you may need to incorporate an orchestration tool into your deployment process
1. Discuss the pros and cons of using Elastic Container Service (ECS) over other **orchestration tools** like Kubernetes, Mesos, and Docker Swarm
1. Configure an **Application Load Balancer** along with **ECS** to run a set of microservices
1. Integrate **ECR** into the deployment process
1. Send **container logs** to CloudWatch


---

### TestDriven.io

Much of this tutorial comes from the following course I wrote at [Testdriven.io](http://testdriven.io/)...

<h4><em>Microservices with Docker, Flask, and React</em></h4>

<div text-align="center">
  <img src="images/cover_small.png" style="max-width: 40%; border:2px solid; border-color:grey; box-shadow: none;" alt="microservice tech">
</div>

---

### Architecture

https://github.com/testdrivenio/testdriven-app-2.2/tree/part4

--

| Name      | Container   | Tech                |
|-----------|-------------|---------------------|
| Users API | `users`     | Flask, gunicorn     |
| Users DB  | `users-db`  | Postgres            |
| Client    | `client`    | React, React-Router |
| Nginx     | `nginx`     | Nginx               |
| e2e Tests | N/A         | TestCafe            |

<div>
  <img src="images/tech.png" style="max-width: 20%; border:0; box-shadow: none; padding-top:20px" alt="microservice tech">
</div>

--

#### In general, services are...

1. Organized around domain
1. Easy to replace (ideally stateless)
1. Implemented using different technologies

---

### Project Setup

--

Fire up the app locally:

```sh
$ git clone https://github.com/testdrivenio/testdriven-app-2.2 \
  --branch part4 --single-branch
$ cd testdriven-app-2.2 && git checkout tags/part4 -b master
$ export REACT_APP_USERS_SERVICE_URL=http://localhost
$ docker-compose -f docker-compose-dev.yml up -d --build
```

<small><em><strong>NOTE:</strong> Using Docker Machine? Replace `localhost` above with `DOCKER_MACHINE_IP`.</em></small>

--

#### Docker Compose

An orchestration tool for running multi-container apps.

*Often, when developing applications with a microservice architecture, you cannot fully test out all services until you deploy to a staging server. This takes much too long to get feedback. Docker helps to speed up this process by making it easier to link together small, independent services locally.*

Docker 101: http://mherman.org/docker-workshop

<img src="images/docker-compose.png" alt="docker compose logo" style="width:50px;">

---

### Why Microservices?

--

**Pros**

1. *Separation of Concerns*: different apps can have different code bases and dependencies, localized errors, less coupling can lead to easier scaling
1. *Smaller Code Bases*: without having to grasp the entire system, it's often easier to understand the code base

--

**Cons**

1. *Design Complexity*: microservices are complex, start with modules
1. *Network Complexity*: many helper functions become AJAX calls, ping-pong-like affect in terms of network requests, network lag
1. *Data Persistence*: managing state (DBs, queues, service discovery) is hard
1. *Security*: more surface area = more areas prone to attack
1. *Integration Tests*: testing is hard, especially if you try to test like you'd test a monolith

--

<img src="images/microservices.png" style="max-width: 7%; border:0; box-shadow: none;" alt="microservice">

You need - *Strong communication + docs, mature devops, lots of planning*

<small class="center">More on microservices: https://testdriven.io/part-one-microservices</small>

---

class: center, middle

## Containerization

---

### Users DB

<div>
  <img src="images/testdriven-users-db.png" style="max-width:100%; border:0; box-shadow: none;" alt="testdriven-users-db">
</div>

---

### Users DB

https://github.com/testdrivenio/testdriven-app-2.2/tree/part4/services/users/project/db

#### Steps:

1. Review *[Dockerfile](https://github.com/testdrivenio/testdriven-app-2.2/blob/part4/services/users/project/db/Dockerfile)* and *[docker-compose-dev.yml](https://github.com/testdrivenio/testdriven-app-2.2/blob/part4/docker-compose-dev.yml)*
1. Build image, run container:

    ```sh
    $ docker-compose -f docker-compose-dev.yml up -d --build users-db
    ```

1. Test/Sanity Check:

    ```sh
    docker exec -ti users-db psql -U postgres -W
    ```

<div>
  <img src="images/postgres.png" style="max-width: 20%; border:0; box-shadow: none;" alt="postgres logo">
</div>

---

### Users API

<div>
  <img src="images/testdriven-users.png" style="max-width:100%; border:0; box-shadow: none;" alt="testdriven-users">
</div>

---

### Users API

https://github.com/testdrivenio/testdriven-app-2.2/tree/master/services/users

#### Steps:

1. Review the [code](https://github.com/testdrivenio/testdriven-app-2.2/tree/master/services/users), *[Dockerfile-dev](https://github.com/testdrivenio/testdriven-app-2.2/blob/master/services/users/Dockerfile-dev)*, and *[docker-compose-dev.yml](https://github.com/testdrivenio/testdriven-app-2.2/blob/part4/docker-compose-dev.yml)*
1. Build image, run container:

    ```sh
    docker-compose -f docker-compose-dev.yml up -d --build users
    ```

1. Test/Sanity Check:

    ```sh
    # create and seed the db
    $ docker-compose -f docker-compose-dev.yml \
      run users python manage.py recreate_db
    $ docker-compose -f docker-compose-dev.yml run users python manage.py seed_db
    # run unit and integration tests
    $ docker-compose -f docker-compose-dev.yml run users python manage.py test
    ```

<div>
  <img src="images/flask.png" style="max-width: 10%; border:0; box-shadow: none;" alt="flask logo">
</div>

---

### Client

<div>
  <img src="images/testdriven-web.png" style="max-width:100%; border:0; box-shadow: none;" alt="testdriven-web">
</div>

---

### Client

https://github.com/testdrivenio/testdriven-app-2.2/tree/master/services/client

#### Steps:

1. Review the [code](https://github.com/testdrivenio/testdriven-app-2.2/tree/master/services/client), *[Dockerfile-dev](https://github.com/testdrivenio/testdriven-app-2.2/blob/master/services/client/Dockerfile-dev)*, *[Dockerfile-prod](https://github.com/testdrivenio/testdriven-app-2.2/blob/master/services/client/Dockerfile-prod)*, and *[docker-compose-dev.yml](https://github.com/testdrivenio/testdriven-app-2.2/blob/part4/docker-compose-dev.yml)*

1. Build image, run container:

    ```sh
    # add env variable
    $ export REACT_APP_USERS_SERVICE_URL=http://localhost
    # build and run:
    $ docker-compose -f docker-compose-dev.yml up -d --build client
    ```

1. Test/Sanity Check: navigate to [http://localhost:3007](http://localhost:3007) in your browser

<br>

<div>
  <img src="images/react-logo.svg" style="max-width: 15%; border:0; box-shadow: none;" alt="react logo">
</div>

---

### Hot Reload

To test hot reload, first open the Docker logs:

```sh
$ docker-compose -f docker-compose-dev.yml logs -f [container-name]
```

--

Make a change to the code, watch the logs update!

```sh
$ docker-compose -f docker-compose-dev.yml logs -f users
Attaching to users
users           | Waiting for postgres...
users           | PostgreSQL started
users           |  * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)
users           |  * Restarting with stat
users           |  * Debugger is active!
users           |  * Debugger PIN: 133-923-613
users           |  * Detected change in '/usr/src/app/project/api/auth.py', reloading
users           |  * Restarting with stat
users           |  * Debugger is active!
users           |  * Debugger PIN: 133-923-613
```

--

<div style="text-align:left;">
  <img src="images/docker-logo.png" style="max-width: 10%; border:0; box-shadow: none;" alt="docker logo">
</div>

For more helpful commands, review https://testdriven.io/part-one-workflow

---

### Nginx

<div>
  <img src="images/testdriven-nginx.png" style="max-width:100%; border:0; box-shadow: none;" alt="testdriven-nginx">
</div>

---

### Nginx

https://github.com/testdrivenio/testdriven-app-2.2/tree/part4/services/nginx

#### Steps:

1. Review the [code](https://github.com/testdrivenio/testdriven-app-2.2/tree/part4/services/nginx), *[Dockerfile-dev](https://github.com/testdrivenio/testdriven-app-2.2/blob/part4/services/nginx/Dockerfile-dev)*, and *[docker-compose-dev.yml](https://github.com/testdrivenio/testdriven-app-2.2/blob/part4/docker-compose-dev.yml)*

1. Build image, run container:

    ```sh
    $ docker-compose -f docker-compose-dev.yml up -d --build nginx
    ```

1. Test/Sanity Check: navigate to [http://localhost](http://localhost)

<br>

<div>
  <img src="images/nginx.png" style="max-width: 20%; border:0; box-shadow: none;" alt="nginx logo">
</div>

---

### End-to-End Tests

<div>
  <img src="images/testdriven-e2e.png" style="max-width:100%; border:0; box-shadow: none;" alt="testdriven-e2e">
</div>

---

### End-to-End Tests

https://github.com/testdrivenio/testdriven-app-2.2/tree/part4/e2e

#### Notes:

1. These are not containerized üò¢
1. Check out the TestCafe 101 @ http://mherman.org/testcafe-example

#### Steps:

1. Review the [code](https://github.com/testdrivenio/testdriven-app-2.2/tree/part4/e2e) and *[docker-compose-prod.yml](https://github.com/testdrivenio/testdriven-app-2.2/blob/part4/docker-compose-prod.yml)*

1. Update the containers, then test:

    ```sh
    $ docker-compose -f docker-compose-prod.yml up -d --build
    # add env variable
    $ export TEST_URL=http://localhost
    # run tests:
    $ testcafe chrome e2e
    ```

<div>
  <img src="images/testcafe-logo.png" style="max-width: 25%; padding-top:25px; box-shadow: none;" alt="testcafe logo">
</div>


---

### Docker Machine

--

Assuming you already have an AWS account [setup](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/get-set-up-for-amazon-ec2.html) along with [IAM](https://aws.amazon.com/iam/) and your AWS credentials are stored in an *~/.aws/credentials* file, create a new host on an EC2 instance:

```sh
$ docker-machine create --driver amazonec2 pytn
```

--

Once done, set it as the active host and point the Docker client at it:

```sh
$ docker-machine env pytn
$ eval $(docker-machine env pytn)
```

--

Grab the IP address associated with the new EC2 instance and use it to set the `REACT_APP_BASE_URL` environment variable:

```sh
$ docker-machine ip pytn
$ export REACT_APP_BASE_URL=http://DOCKER_MACHINE_IP
```

<small><em><strong>NOTE:</strong> The `REACT_APP_BASE_URL` environment variable must be set at the build-time, so it is available *before* we kick off Create React App's production build process.</em></small>

---

### EC2 Deployment

--

Set the secret key:

```sh
$ export SECRET_KEY=my_precious
```

--

Build the images, spin up the containers:

```sh
$ docker-compose -f docker-compose-prod.yml up -d --build
```

--

Create and seed the database:

```sh
$ docker-compose -f docker-compose-prod.yml \
  run users python manage.py recreate_db
$ docker-compose -f docker-compose-prod.yml run users python manage.py seed_db
```

--

Update the `TEST_URL` environment variable and then run the e2e tests:

```sh
$ testcafe chrome e2e
```

<div>
  <img src="images/aws.png" style="max-width: 12%; padding-top:20px; box-shadow: none;" alt="aws logo">
</div>


<small>For more, review https://docs.docker.com/machine/examples/aws/.</small>

---

class: center, middle

## Orchestration

---

### That's it!

What's next?

--

#### Resources:

1. [Slides](http://mherman.org/presentations/microservices-flask-docker)
1. ***[Testdriven.io](http://testdriven.io/) - full tutorial!*** ‚ù§Ô∏è
1. [How to Build 12 Factor Microservices on Docker](https://www.packtpub.com/books/content/how-to-build-12-factor-design-microservices-on-docker-part-1)
1. [Docker Cheat Sheet](https://github.com/wsargent/docker-cheat-sheet)

--

#### Other examples:

1. [Developing and Testing Microservices With Docker](http://mherman.org/blog/2017/04/18/developing-and-testing-microservices-with-docker)
1. [Developing Microservices - Node, React, and Docker](http://mherman.org/blog/2017/05/11/developing-microservices-node-react-docker)
1. [Developing React with Docker](http://mherman.org/node-workshop/slides/react-docker)

--

#### Self-promotion:

1. Want more? Check out my Workshop at [Develop Denver](https://developdenver.org/schedule) on August 11th, 2017 - *Developing and Testing Microservices - Node, React, and Docker*
1. 50% off [Real Python](https://realpython.com) - *50BOLDPY*

---

### Questions?

--

Well...




    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
